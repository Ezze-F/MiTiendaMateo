{% extends 'a_inicio/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-4 text-center">
        ðŸ“¦ Control de Stock y Vencimientos
    </h2>

    <!-- BOTÃ“N CARGAR COMPRAS PAGADAS -->
    <div class="d-flex justify-content-start mb-3">
        <a href="{% url 'a_stock:cargar_compras' %}" class="btn btn-primary">
            <i class="fa-solid fa-cart-arrow-down me-2"></i> Cargar Compras Pagadas
        </a>
    </div>

    <!-- FILTROS PRINCIPALES -->
    <form method="GET" class="row g-3 mb-4">

        <!-- Buscar por nombre o local -->
        <div class="col-md-4">
            <input 
                type="text" 
                name="buscar" 
                value="{{ request.GET.buscar }}" 
                placeholder="Buscar por producto o local..." 
                class="form-control"
            >
        </div>

        <!-- FILTRO: Locales -->
        <div class="col-md-3">
            <select name="local" class="form-select">
                <option value="">Todos los locales</option>
                {% for l in locales %}
                    <option value="{{ l.id_loc_com }}" 
                        {% if request.GET.local == l.id_loc_com|stringformat:"s" %}selected{% endif %}>
                        {{ l.nombre_loc_com }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- BOTÃ“N FILTRAR -->
        <div class="col-md-2">
            <button class="btn btn-primary w-100">
                <i class="fa-solid fa-filter me-2"></i> Filtrar
            </button>
        </div>

    </form>

    <!-- TABLA DE STOCK -->
    <div class="table-responsive">
        <table class="table table-striped table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Local Comercial</th>
                    <th>Stock Actual</th>
                    <th>Stock MÃ­nimo</th>
                    <th>Lotes Registrados</th>
                    <th>Lote PrÃ³ximo a Vencer</th>
                </tr>
            </thead>

            <tbody>
                {% for s in stocks %}
                <tr>
                    <!-- Producto -->
                    <td>{{ s.id_producto.nombre_producto }}</td>

                    <!-- Local -->
                    <td>{{ s.id_loc_com.nombre_loc_com }}</td>

                    <!-- Stock Actual -->
                    <td>
                        {% if s.stock_pxlc == 0 %}
                            <span class="badge bg-danger">{{ s.stock_pxlc }}</span>
                        {% elif s.stock_pxlc <= s.stock_min_pxlc %}
                            <span class="badge bg-warning text-dark">{{ s.stock_pxlc }}</span>
                        {% else %}
                            <span class="badge bg-success">{{ s.stock_pxlc }}</span>
                        {% endif %}
                    </td>

                    <!-- Stock MÃ­nimo -->
                    <td>{{ s.stock_min_pxlc }}</td>

                    <!-- Lotes Registrados -->
                    <td>
                        <a href="{% url 'a_stock:ver_lotes' s.id_producto.id_producto %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fa-solid fa-layer-group me-1"></i> {{ s.lotes_count }}
                        </a>
                    </td>

                    <!-- Lote PrÃ³ximo a Vencer -->
                    <td>
                        {% if s.lote_proximo %}
                            {% if s.lote_proximo.fecha_vencimiento <= today %}
                                <span class="badge bg-danger">
                                    {{ s.lote_proximo.fecha_vencimiento }}
                                </span>
                            {% elif s.lote_proximo.fecha_vencimiento <= proximo %}
                                <span class="badge bg-warning text-dark">
                                    {{ s.lote_proximo.fecha_vencimiento }}
                                </span>
                            {% else %}
                                <span class="badge bg-success">
                                    {{ s.lote_proximo.fecha_vencimiento }}
                                </span>
                            {% endif %}
                        {% else %}
                            â€”
                        {% endif %}
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No hay registros de stock para mostrar.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}
